<div>
  <h1>Dashboard</h1>

  <% if @myshelter.present? %>
    <div class="shelter-show-body ">
      <div class="em-show-container">
        <div class="d-flex justify-content-between align-items-center mb-5">
          <div class="normal-head"> Your Shelter: <%= @myshelter.name %></div>
        </div>
        <div class="shelters-card">

            <%# ///////////shelters photos slide show start///////////////////// %>
            <div class="animal-show-card-image">
              <div id="animals-show-photos" class="carousel slide" data-bs-ride="true">

                <div class="carousel-indicators"> <%# switch buttons %>
                    <% @myshelter.photos.each_with_index do |photo, index| %>
                    <button type="button" data-bs-target="#animals-show-photos" data-bs-slide-to="<%= index %>" class="<%= "active" if index == 0 %>" aria-current="true" aria-label="Slide 1"></button>
                    <% end %>
                </div>

                <div class="carousel-inner"> <%# photos %>
                  <% if @myshelter.photos.attached? %>
                    <% @myshelter.photos.each_with_index do |photo, index| %>
                      <div class="carousel-item <%= "active" if index == 0 %>">
                        <%= image_tag photo, class: "d-block w-100" %>
                      </div>
                    <% end #each %>
                  <% else %>
                    <div class="carousel-item active">
                      <%= image_tag "pets_icons.jpg", class: "d-block w-100" %>
                    </div>
                  <% end #if %>
                </div>

                <button class="carousel-control-prev" type="button" data-bs-target="#animals-show-photos" data-bs-slide="prev">
                  <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                  <span class="visually-hidden">Previous</span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#animals-show-photos" data-bs-slide="next">
                  <span class="carousel-control-next-icon" aria-hidden="true"></span>
                  <span class="visually-hidden">Next</span>
                </button>
              </div>
            </div>
            <%# ///////////shelters photos slide show end//////////////////////// %>

          <div class="shelters-card-text">
          <div class="card-head mb-3">Contact</div>
          <br>
          <div class="card-link mb-2"><i class="fa-solid fa-phone"></i>&nbsp&nbsp  <%= @myshelter.phone_number %></div>
          <div class="card-link mb-2"><i class="fa-solid fa-envelope"></i>&nbsp&nbsp  <%= @myshelter.email %></div>
          <div class="card-link mb-2"><i class="fa-solid fa-location-dot"></i>&nbsp&nbsp  <%= @myshelter.location %></div>
          <br><br>
          <div class="card-head mb-3">Opening times</div>
          <table class="my-2 padding-between-cols">
            <tbody>
              <tr>
                <th class="card-sub">Monday</th>
                <th class="card-sub">closed</th>
              </tr>
              <tr>
                <th class="card-sub">Tuesday</th>
                <th class="card-sub">14 - 16 Uhr</th>
              </tr>
              <tr>
                <th class="card-sub">Wednesday</th>
                <th class="card-sub">closed</th>
              </tr>
              <tr>
                <th class="card-sub">Thursday</th>
                <th class="card-sub">14 - 16 Uhr</th>
              </tr>
              <tr>
                <th class="card-sub">Friday</th>
                <th class="card-sub">14 - 16 Uhr</th>
              </tr>
              <tr>
                <th class="card-sub">Saturday</th>
                <th class="card-sub">12 - 13:30 Uhr</th>
              </tr>
              <tr>
                <th class="card-sub">Sunday</th>
                <th class="card-sub">13:30 - 16 Uhr</th>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="shelter-card-maplinks">
          <%= image_tag("map-dummy-shelter.png") %>
          <br><br>
          <div> <%= link_to "Edit My Shelter", edit_shelter_path(@myshelter), class:"btn allanimals-button btn-font" %>  </div>
          <br>
          <div> <%= link_to "Delete Shelter", shelter_path(@myshelter), data: { turbo_method: :delete, turbo_confirm: "Are you sure you want to delete your shelter and every animal and fundraising cause?"}, class:"btn allanimals-button btn-font" %>  </div>
        </div>
      </div>
    </div>
  <% else %>
    <%= link_to "Add shelter", new_shelter_path %>
  <% end %>

  <div>
    <% if @myshelter.present? %>
      <%# <h2> Your Shelter Dashboard</h2> %>

      <div> <h2> Booked Volunteering Slots </h2>
        <h3>Total: <%= @shelter_caretakings.count %> </h3>
       <div>
        <% if @pending_shelter_caretakings.any? %>
          <h3> Pending: <%= @pending_shelter_caretakings.count %> </h3>
          <% end %>
          <% @pending_shelter_caretakings.each do |caretaking| %>
            <div class="notification shadow">
              <div>
                <% if caretaking.user.avatar.key %>
                    <%= image_tag caretaking.user.avatar, class: "avatar-large" %>
                  <% else %>
                    <%= image_tag "avatar.png", class: "avatar-large" %>
                  <% end %>
                </div>
                <div>
                  <% if caretaking.animal.photos.attached? %>
                    <%= cl_image_tag(caretaking.animal.photos[0].key, class:"avatar-large") %>
                  <% else %>
                    <%= image_tag "pets_icons.jpg", class: "avatar-large" %>
                  <% end %>
                </div>
              <div class="notification-content">
                <p><small><%= caretaking.date %></small> for <small><%= caretaking.animal.name %></small></p>
                <p> Booked: <%= caretaking.category.name %> </p>
                <p> <%= caretaking.user.first_name %> 's comment: <%= caretaking.comment %></p>
              </div>
              <div>
                <%= link_to "Decline", caretaking_path(caretaking), data: { turbo_method: :delete, turbo_confirm: "Are you sure you want to delete this booking?"}, class: "btn btn-danger" %>
                <%= link_to "Confirm", confirm_caretaking_path(caretaking), data: { turbo_method: :put, turbo_confirm: "Confirm this booking?"}, class: "btn btn-success" %>
              </div>
            </div>
          <% end %>
        </div>
      <div>
        <% if @confirmed_shelter_caretakings.any? %>
          <h3> Confirmed: <%= @confirmed_shelter_caretakings.count %></h3>
          <% end %>
          <% @confirmed_shelter_caretakings.each do |caretaking| %>
            <div class="notification shadow">
              <div>
                <% if caretaking.user.avatar.key %>
                    <%= image_tag caretaking.user.avatar, class: "avatar-large" %>
                  <% else %>
                    <%= image_tag "avatar.png", class: "avatar-large" %>
                  <% end %>
                </div>
                <div>
                  <% if caretaking.animal.photos.attached? %>
                    <%= cl_image_tag(caretaking.animal.photos[0].key, class:"avatar-large") %>
                  <% else %>
                    <%= image_tag "pets_icons.jpg", class: "avatar-large" %>
                  <% end %>
                </div>
              <div class="notification-content">
                <p><small><%= caretaking.date %></small> for <small><%= caretaking.animal.name %></small></p>
                <p> Booked: <%= caretaking.category.name %> </p>
                <p> <%= caretaking.user.first_name %> 's comment: <%= caretaking.comment %></p>
              </div>
              <p class="btn btn-success disabled">Confirmed</p>
              <%= link_to "X", caretaking_path(caretaking), data: { turbo_method: :delete, turbo_confirm: "Are you sure you want to delete this booking?"}, class: "btn btn-danger" %>
            </div>
          <% end %>
      </div>

      <div> <h3> My Shelter Animals </h3>
        <%= link_to "Add animal", new_animal_path %>
          <div class="row">
              <% @shelter_animals.each do |animal| %>
                <div class="col-4">
                <h4> <%= animal.name %></h4>
                <%= link_to(animal_path(animal)) do %>
                  <div class="animal animal-overview">
                    <div class="animal-dashboard-img">
                      <%# guard clause to prevent showing error if the user didn't apply photos for the animal %>
                      <%# iterate to show all photos %>
                      <% if animal.photos.attached? %>
                        <% animal.photos.each_with_index do |photo, index| %>
                            <%= cl_image_tag(animal.photos[0].key, class:"animal-dashboard-img") %>
                        <% end #each %>
                      <% else %>
                          <%= image_tag "pets_icons.jpg", style: "width: 50%" %>
                      <% end #if %>
                    </div>
                    <div class="dashboard-links">
                    <%= link_to "Show profile", animal_path(animal) %>
                    <%= link_to "Edit profile", edit_animal_path(animal), class: "text-primary" %>
                    <%= link_to "+ Add Emergency", new_animal_emergency_path(animal) %>
                    <%= link_to "X (delete)", animal_path(animal), data: { "turbo-method": :delete }, class: "text-danger" %>
                    </div>
                  </div>
                <%end%>
                </div>
              <% end %>
            </div>
          </div>
      </div>

      <div> <h2> Your Fundraiser</h2>
        <div class="row">
          <% if @shelter_emergencies.any? %>
            <% @shelter_emergencies.each do |emergency| %>
              <div class="col-4">
                <h4> <%= emergency.title %></h4>
                <h6> Fundraising for <%= emergency.animal.name %></h6>
                <div class="animal-dashboard-img">
                        <%# guard clause to prevent showing error if the user didn't apply photos for the animal %>
                        <%# iterate to show all photos %>
                        <% if emergency.photos.attached? %>
                          <% emergency.photos.each_with_index do |photo, index| %>
                              <%= cl_image_tag(emergency.photos[0].key, class:"animal-dashboard-img") %>
                          <% end #each %>
                        <% else %>
                            <%= image_tag "pets_icons.jpg", style: "width: 50%" %>
                        <% end #if %>
                  <%= link_to "Show", emergency_path(emergency) %>
                  <%= link_to "Edit", edit_emergency_path(emergency) %>
                  <%= link_to "Delete", emergency_path(emergency), data: { turbo_method: :delete, turbo_confirm: "Are you sure you want to delete this fundraiser?"}, class: "btn btn-danger" %>
                  <div>
                    <% fgoal = emergency.fundraising_goal.to_i %>
                    <% sum_of_donations = emergency.donations.sum(:donation_amount) %>
                    <p class="fund-sub">Donations: <%= sum_of_donations %>â‚¬ | Goal: <%= fgoal %>â‚¬<%= "   ðŸŽ‰ðŸŽŠðŸ¥³" if sum_of_donations > fgoal %></p>
                    <% progress = (emergency.donations.sum(:donation_amount).to_f / emergency.fundraising_goal.to_i).round(2) * 100 %>
                    <% progress = 100 if progress > 100 %>
                    <p> <%= emergency.donations.count %> people have donated to this cause </p>
                  </div>
                </div>
                <div class="progress">
                  <div class="progress-bar" role="progressbar" style="width: <%= progress %>%" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100"></div>
                </div>

              </div>
            <% end %>
          <% else %>
            <p> Create a fundraising appeal for an animal by clicking "+Add Emergency" on the animal's profile</p>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>

  <%# Animal Lover Dashboard %>
  <div>
    <% if @user_caretakings.any? %>
      <h2> Your Booked Volunteering </h2>
      <div>
        <% @user_caretakings.each do |caretaking| %>
          <div class="notification shadow">
            <% if caretaking.animal.photos.attached? %>
              <%= cl_image_tag(caretaking.animal.photos[0].key, class:"avatar-large") %>
            <% else %>
              <%= image_tag "pets_icons.jpg", class: "avatar-large" %>
            <% end %>
            <div class="notification-content">
              <p><small><%= caretaking.date %></small> for <small><%= caretaking.animal.name %></small></p>
              <%= caretaking.category.name %>
              <p> Your comment: <%= caretaking.comment %></p>
              <% if caretaking.accepted? %>
                <p class="btn btn-dark disabled">Waiting for confirmation</p>
              <% else %>
                <p class="btn btn-success disabled">Volunteer slot confirmed</p>
              <% end %>
              <%= link_to "X", caretaking_path(caretaking), data: { turbo_method: :delete, turbo_confirm: "Are you sure you want to delete this booking?"}, class: "btn btn-danger" %>
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <% unless current_user.shelter %>
        <h3> You have not booked any volunteering slots</h3>
        <%= link_to "Check out volunteering possibilities near you", animals_path(@animals) %>
      <% end %>
    <% end %>
  </div>


  <div>
    <% if @user_donations.any? %>
      <h2> Your Donations </h2>
      <div class="container-bottom">
        <% @user_donations.each do |donation| %>
        <div class="emergency-card">
          <div class="shelter-card-text emergency-card-element">
            <% emergency = donation.emergency %>
            <h4 class="card-head"> You donated <%= donation.donation_amount.to_i %> â‚¬</h4>
            <h6 > to <%= emergency.title %></h6>
            <p><strong><%= link_to "See more info â†’", emergency_path(emergency), class: "card-link" %></a></strong></p>
            <% emergency = donation.emergency %>
            <% fgoal = emergency.fundraising_goal.to_i %>
            <% sum_of_donations = emergency.donations.sum(:donation_amount) %>
            <p class="fund-sub">Donations: <%= sum_of_donations %>â‚¬ | Goal: <%= fgoal %>â‚¬<%= "   ðŸŽ‰ðŸŽŠðŸ¥³" if sum_of_donations > fgoal %></p>
            <% progress = (emergency.donations.sum(:donation_amount).to_f / emergency.fundraising_goal.to_i).round(2) * 100 %>
            <% progress = 100 if progress > 100 %>
            <div class="progress">
              <div class="progress-bar" role="progressbar" style="width: <%= progress %>%" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
          </div>
          <div class="shelter-card-image">
            <% if emergency.photos.attached? %>
              <%= image_tag(emergency.photos[0]) %>
            <% end %>
          </div>
        </div>
        <% end %>
      </div>
    <% else %>
      <% unless current_user.shelter %>
        <h3> You have not donated to any urgent fundraising causes</h3>
        <%= link_to "Help shelter animals in desperate need", emergencies_path(@emergencies) %>
      <% end %>
    <% end %>
  </div>

</div>
